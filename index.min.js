"use strict";

function write(data, file) {
    return fs.writeFile(file, data, function(err) {
        null !== err && console.error(err);
    });
}

function stream(data, res, header) {
    res.header("Content-Type", header), res.send(data);
}

function sitemap(options) {
    return new SITEMAP(options);
}

function SITEMAP(options) {
    var opt = options || Object.create(null), http = "https" == opt.http ? "https://" : "http://", url = String(opt.url || "127.0.0.1"), port = isNaN(opt.port) ? "" : ":" + Number(opt.port);
    this.my = {
        url: http + url + port,
        sitemap: String(opt.sitemap || "sitemap.xml"),
        robots: String(opt.robots || "robots.txt"),
        route: "object" == typeof opt.route ? opt.route : Object.create(null)
    }, this.my.sitemap = resolve(this.my.sitemap), this.my.robots = resolve(this.my.robots), 
    this.map = "object" == typeof opt.map ? opt.map : Object.create(null), opt.generate && opt.generate._router && this.generate(opt.generate);
}

try {
    var fs = require("fs"), resolve = require("path").resolve;
} catch (MODULE_NOT_FOUND) {
    console.error(MODULE_NOT_FOUND), process.exit(1);
}

module.exports = sitemap, SITEMAP.prototype.generate = function(app) {
    if (app && app._router) {
        if (app._router.stack) return this.generate4(app);
        if (app._router.map) return this.generate3(app);
    }
    throw new Error("missing express configuration");
}, SITEMAP.prototype.generate4 = function(app) {
    for (var routing = app._router.stack, i = 0, ii = routing.length; ii > i; i++) {
        var route = routing[i].route;
        void 0 !== route && void 0 !== route.methods && void 0 !== route.methods.get && (this.map[route.path] = [ "get" ]);
    }
    return this.map;
}, SITEMAP.prototype.generate3 = function(app) {
    for (var routing = app.routes.get, i = 0, ii = routing.length; ii > i; i++) {
        var route = routing[i];
        void 0 !== route && void 0 !== route.path && (this.map[route.path] = [ "get" ]);
    }
    return this.map;
}, SITEMAP.prototype.tickle = function() {
    if (void 0 !== global.tickle && void 0 !== global.tickle.route) {
        for (var route in global.tickle.route) this.map[route] = [];
        return this.map;
    }
    return Object.create(null);
}, SITEMAP.prototype.reset = function() {
    var r = Object.create(null);
    return this.map = r, r;
}, SITEMAP.prototype.xml = function() {
    var route = this.my.route, sitemap = this.map, data = '<?xml version="1.0" encoding="UTF-8"?>';
    data += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">';
    for (var uri in sitemap) {
        var rr = route.ALL || route[uri] || !1;
        rr && (rr.disallow || rr.hide) || (data += "<url><loc>" + this.my.url + uri + "</loc>", 
        "object" == typeof rr && (void 0 !== rr.lastmod && (data += "<lastmod>" + rr.lastmod + "</lastmod>"), 
        void 0 !== rr.changefreq && (data += "<changefreq>" + rr.changefreq + "</changefreq>"), 
        void 0 !== rr.priority && (data += "<priority>" + rr.priority + "</priority>")), 
        data += "</url>");
    }
    return data += "</urlset>";
}, SITEMAP.prototype.robots = function() {
    var temp = !0, route = this.my.route, sitemap = this.map, data = "User-agent: *\n";
    for (var uri in sitemap) {
        var rr = route[uri];
        if (route.ALL && route.ALL.disallow && !route.ALL.hide) {
            temp = !1, data += "Disallow: /\n";
            break;
        }
        rr && rr.disallow && !rr.hide && (temp = !1, data += "Disallow: " + uri + "\n");
    }
    return temp && (data += "Disallow: \n"), data;
}, SITEMAP.prototype.XMLtoFile = function() {
    return write(this.xml(), this.my.sitemap);
}, SITEMAP.prototype.TXTtoFile = function() {
    return write(this.robots(), this.my.robots);
}, SITEMAP.prototype.toFile = function() {
    write(this.xml(), this.my.sitemap), write(this.robots(), this.my.robots);
}, SITEMAP.prototype.XMLtoWeb = function(res) {
    return stream(this.xml(), res, "application/xml");
}, SITEMAP.prototype.TXTtoWeb = function(res) {
    return stream(this.robots(), res, "text/plain");
};
